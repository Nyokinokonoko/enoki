---
import Layout from "../../layouts/Layout.astro";
import {
  getAllPosts,
  getPostsByCategory,
  getAvailableCategories,
  CATEGORIES,
} from "../../lib/contentful";
import BlogList from "../../components/BlogList.astro";
import CategoryToggle from "../../components/CategoryToggle.astro";

export async function getStaticPaths() {
  // Generate paths for all predefined categories except "all"
  return CATEGORIES.filter((cat) => cat.id !== "all").map((category) => ({
    params: { category: category.id },
  }));
}

const category = (Astro.params.category || "").toLowerCase();
const posts = await getPostsByCategory(category);

// Get all available categories and their post counts for the toggle
const availableCategories = await getAvailableCategories();

// Find the category label for display
const categoryInfo = CATEGORIES.find((cat) => cat.id === category);
const categoryLabel = categoryInfo ? categoryInfo.label : category;
---

<Layout
  title={`「${categoryLabel}」カテゴリの投稿一覧 | notes.kinokonoko.io`}
  description={`「${categoryLabel}」カテゴリに関連する技術記事と開発ノートの一覧です。`}
  ogType="website"
>
  <main>
    <div class="flex flex-col items-center">
      <CategoryToggle
        activeCategory={category}
        availableCategories={availableCategories}
      />
      {
        posts.length === 0 ? (
          <p class="text-center mt-8">
            このカテゴリに該当する投稿はありません。
          </p>
        ) : (
          <BlogList posts={posts} />
        )
      }
    </div>
  </main>
</Layout>

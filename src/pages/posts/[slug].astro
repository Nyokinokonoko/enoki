---
import Layout from "../../layouts/Layout.astro";
import { contentfulClient } from "../../lib/contentful";
import type { BlogPost } from "../../lib/contentful";
import { marked } from "marked";
import "prismjs/themes/prism-tomorrow.css";

export async function getStaticPaths() {
  const entries = await contentfulClient.getEntries<BlogPost>({
    content_type: "blogPost",
  });

  function addPrismLanguageClasses(html: string) {
    // First, handle code blocks with language specified in markdown (```language)
    return html.replace(
      /<pre><code( class="[^"]*")?>([\s\S]*?)<\/code><\/pre>/g,
      (match, classAttr, code) => {
        // Check if there's already a language class
        if (classAttr && classAttr.includes("language-")) {
          return match; // Already has language class, leave it as is
        }

        // Try to extract language from the first line (e.g., ```js)
        const firstLine = code.split("\n")[0];
        const langMatch = firstLine.match(/^```?([a-zA-Z0-9+-]+)/);

        let lang = langMatch ? langMatch[1] : null;
        let cleanCode = lang ? code.replace(/^```?[a-zA-Z0-9+-]+\n/, "") : code;

        // If no language is detected, try to guess based on content
        if (!lang) {
          if (
            code.includes("function") ||
            code.includes("var ") ||
            code.includes("const ") ||
            code.includes("let ")
          ) {
            lang = "javascript";
          } else if (code.includes("#include") || code.includes("int main(")) {
            lang = "cpp";
          } else if (
            code.includes("using System;") ||
            code.includes("namespace ")
          ) {
            lang = "csharp";
          }
        }

        let langClass = lang ? ` class="language-${lang}"` : classAttr || "";
        return `<pre><code${langClass}>${cleanCode}</code></pre>`;
      }
    );
  }

  const paths = await Promise.all(
    entries.items.map(async (entry) => ({
      params: { slug: entry.fields.slug },
      props: {
        title: entry.fields.title,
        date: entry.fields.publishDate,
        content: addPrismLanguageClasses(await marked(entry.fields.content)),
        tags: entry.fields.tags, // Ensure tags are fetched
      },
    }))
  );
  return paths;
}

const { title, date, content, tags } = Astro.props;
---

<Layout>
  <Fragment slot="head">
    <title>{title} | notes.kinokonoko.io</title>
    <!-- Import Prism CSS in the head -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css"
    />
  </Fragment>
  <main class="container max-w-3xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-2">{title}</h1>
    <div class="flex flex-wrap items-center gap-2 mb-2">
      <span class="text-[var(--text-secondary)]">
        {new Date(date).toLocaleDateString()}| Tags:&nbsp;
      </span>
      {
        Array.isArray(tags) && tags.length > 0 ? (
          tags.map((tag, i) => (
            <>
              <a
                href={`/tags/${encodeURIComponent(tag.trim().toLowerCase())}/`}
                class="underline hover:text-blue-500 text-[var(--text-secondary)]"
                style="text-underline-offset: 2px; text-decoration-skip-ink: none;"
              >
                {tag}
              </a>
              {i < tags.length - 1 && (
                <span class="text-[var(--text-secondary)]">,&nbsp</span>
              )}
            </>
          ))
        ) : (
          <span class="text-[var(--text-secondary)]">None</span>
        )
      }
    </div>
    <article
      class="mt-8 prose prose-sm md:prose-base dark:prose-invert"
      set:html={content}
    />
  </main>
  <!-- Load Prism.js and language components for client-side syntax highlighting -->
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"
  ></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"
  ></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-csharp.min.js"
  ></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js"
  ></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"
  ></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-objectivec.min.js"
  ></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-swift.min.js"
  ></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"
  ></script>
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"
  ></script>
  <script is:inline>
    // Run highlighting once the DOM is fully loaded
    document.addEventListener("DOMContentLoaded", () => {
      Prism.highlightAll();
    });
  </script>
</Layout>
